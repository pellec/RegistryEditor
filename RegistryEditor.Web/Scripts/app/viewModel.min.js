define(["require","exports","dataservice","keyValueViewModelFactory","serverModel"],function(n,t,i,r,u){var o=i,e=r,s=u,f=new o.DataService,h=function(){function n(){this.keys=ko.observableArray([]),this.servers=ko.observableArray([]),this.values=ko.observableArray([]),this.currentValue=ko.observable(),this.isLoading=ko.observable(!1),this.currentKey=ko.observable(""),this.fadeInContainer=ko.observable(!1),this.serverName=ko.observable(""),this.newKey=ko.observable(""),this.newValue=ko.observable(""),this.breadcrumbs=ko.observableArray([]),this.configureRouting(),this.getServers()}return n.prototype.configureRouting=function(){var n=this;$.sammy(function(){this.get(/\#\/registry\/(.*)/,function(){console.log("key route triggered"),console.dir(this),n.handleKeyChange(this.params.splat.join("/"))}),this.get("#/server/:name",function(){console.log("server route triggered with name"),console.dir(this),n.currentKey(""),n.serverName(this.params.name),n.breadcrumbs([]),n.breadcrumbs.push(this.params.name),n.getKey()}),this.get(/\#\/server\/*\/(.*)/,function(){console.log("server route triggered with reg"),console.dir(this);var t=this.params.splat[0].split("/");n.serverName(t[0]),t.shift(),n.breadcrumbs([]),n.breadcrumbs.push(n.serverName()),$.each(t,function(t,i){i!==""&&n.breadcrumbs.push(i)}),n.handleKeyChange(t.join("/")),n.getKey()}),this.get("",function(){console.log("default route triggered")})}).run()},n.prototype.createKey=function(){var n=this;this.isLoading(!0),f.saveKey({serverName:this.serverName(),subKey:this.currentKey(),newKey:this.newKey()}).then(function(){toastr.success('Successfully created key "'+n.newKey()+'"'),n.getKey()},function(){toastr.error('Could not create key "'+n.newKey()+'"')}).always(function(){n.isLoading(!1),n.newKey("")})},n.prototype.saveValue=function(n){var t=this,i={serverName:this.serverName()};$.extend(i,n.getData()),$.when(f.saveValue(i)).done(function(){t.getKey(),toastr.success('Successfully saved value: "'+t.currentValue().name+'" in key: "'+t.currentKey()+'"!')}).fail(function(n){console.dir(n),toastr.error("Could not save the value "+t.currentValue().name+"for key "+t.currentKey())}).always(function(){t.currentValue("")})},n.prototype.isValid=function(n){return n!==undefined&&n!==""},n.prototype.handleKeyChange=function(n){this.currentKey(n),this.getKey()},n.prototype.setCurrentValue=function(n){n.IsNew?(n.KeyName=this.currentKey(),n.Name=this.newValue(),this.currentValue((new e.KeyValueViewModelFactory).create(n))):this.currentValue(n)},n.prototype.getServers=function(){var n=this;$.when(f.getServers()).then(function(t){n.servers.map(t,s.ServerModel)})},n.prototype.getKey=function(){var n=this,t;this.isLoading(!0),this.fadeInContainer(!1),this.keys([]),this.values([]),t={serverName:this.serverName(),subKey:this.currentKey()===undefined?"":this.currentKey()},$.when(f.getKey(t)).then(function(t){n.currentKey(t.KeyName),n.fadeInContainer(!0),n.keys(t.SubKeys),n.values.mapWithFactory(t.Values,e.KeyValueViewModelFactory)}).always(function(){n.isLoading(!1)})},n.prototype.getKeyUrlForBreadcrumb=function(n){var t="#/server/";return $.each(this.breadcrumbs(),function(i,r){if(r===n)return t+=n,!1;t+=r+"/"}),t},n.prototype.getKeyUrl=function(n){return this.currentKey()===undefined||this.currentKey()===""?"#/server/"+this.serverName()+"/"+n:"#/server/"+this.serverName()+"/"+this.currentKey()+"/"+n},n}();t.ViewModel=h})